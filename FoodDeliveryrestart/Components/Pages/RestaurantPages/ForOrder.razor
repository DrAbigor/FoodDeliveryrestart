@page "/grouporders/malls/{MallId:int}/restaurants/fororder"
@rendermode InteractiveServer

@using System.Linq
@using Microsoft.EntityFrameworkCore
@using FoodDeliveryrestart.Data
@using FoodDeliveryrestart.Domain

@inject IDbContextFactory<FoodDeliveryrestartContext> DbFactory
@inject NavigationManager NavigationManager
@inject FoodDeliveryrestart.Services.GroupOrderState GroupOrderState

<h3>Restaurants available in this mall</h3>

@if (restaurants is null)
{
    <p><em>Loading...</em></p>
}
else if (!restaurants.Any())
{
    <p>No restaurants found in this mall.
        <a href="@($"/grouporders/malls/{MallId}/restaurants")">Return to selection</a>
    </p>
}
else
{
    <!-- Top filter nav: All + each restaurant in the mall -->
    <ul class="nav nav-pills mb-3">
        <li class="nav-item">
            <a class="nav-link @(filterRestaurantId == null ? "active" : "")"
               href="#"
               @onclick="() => SelectFilter(null)">
                All
            </a>
        </li>

        @foreach (var r in restaurants)
        {
            var isSelected = GroupOrderState.SelectedRestaurantIds?.Contains(r.Id) == true;

            <li class="nav-item" @key="r.Id">
                <a class="nav-link @(filterRestaurantId == r.Id ? "active" : "")"
                   href="#"
                   @onclick="() => SelectFilter(r.Id)">
                    @r.Name
                    @if (isSelected)
                    {
                        <span class="badge bg-success ms-2">Selected</span>
                    }
                </a>
            </li>
        }
    </ul>

    <div class="list-group">
        @foreach (var r in filteredRestaurants)
        {
            var allowed = GroupOrderState.SelectedRestaurantIds?.Contains(r.Id) == true;

            <div class="list-group-item d-flex justify-content-between align-items-center"
                 style="cursor:@(allowed ? "pointer" : "not-allowed"); opacity:@(allowed ? "1" : ".55");"
                 @onclick="() => RowClick(r.Id)">

                <div>
                    <strong>@r.Name</strong>
                    <div class="text-muted">@r.CuisineType</div>
                </div>

                <div class="text-end">
                    @if (allowed)
                    {
                        <span class="badge bg-success me-2">Available for group order</span>
                        <button class="btn btn-outline-primary"
                                @onclick:stopPropagation="true"
                                @onclick="() => GoToMenu(r.Id)">
                            View Menu
                        </button>
                    }
                    else
                    {
                        <span class="badge bg-secondary me-2">Not selected</span>
                        <button class="btn btn-outline-secondary" disabled>
                            View Menu
                        </button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter] public int MallId { get; set; }

    private List<Restaurant>? restaurants;
    private int? filterRestaurantId;

    private List<Restaurant> filteredRestaurants =>
        filterRestaurantId == null
            ? (restaurants ?? new())
            : (restaurants?.Where(r => r.Id == filterRestaurantId).ToList() ?? new());

    protected override void OnInitialized()
    {
        // Safety: if user didn't come from selection page, they won't have SelectedRestaurantIds
        if (GroupOrderState.SelectedRestaurantIds == null || !GroupOrderState.SelectedRestaurantIds.Any())
        {
            // send them back to select restaurants
            NavigationManager.NavigateTo($"/grouporders/malls/{MallId}/restaurants");
            return;
        }

        using var ctx = DbFactory.CreateDbContext();
        restaurants = ctx.Restaurant.Where(r => r.MallId == MallId).ToList();
    }

    private void SelectFilter(int? restaurantId) => filterRestaurantId = restaurantId;

    private void RowClick(int restaurantId)
    {
        var allowed = GroupOrderState.SelectedRestaurantIds?.Contains(restaurantId) == true;
        if (!allowed) return;

        GoToMenu(restaurantId);
    }

    private void GoToMenu(int restaurantId)
    {
        NavigationManager.NavigateTo($"/grouporders/restaurants/{restaurantId}/menuitems");
    }
}
