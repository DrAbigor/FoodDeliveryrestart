@page "/grouporders/malls/{MallId:int}/restaurants"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FoodDeliveryrestart.Domain
@using FoodDeliveryrestart.Data

@inject IDbContextFactory<FoodDeliveryrestartContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@inject FoodDeliveryrestart.Services.GroupOrderState GroupOrderState

<PageTitle>Select Restaurants - Group Order</PageTitle>

<div class="group-order-hero">
    <div class="hero-content">
        <h1>Select Restaurants</h1>
        @if (mall != null)
        {
            <p class="subtitle">Choose up to <strong>@MaxRestaurants</strong> restaurants from <strong>@mall.MallName</strong></p>
        }
    </div>
</div>

<div class="group-order-container">
    @if (restaurants is null)
    {
        <div class="card p-3">Loading restaurants...</div>
    }
    else if (!restaurants.Any())
    {
        <div class="card p-3">
            <div class="mb-2">No restaurants available for this mall.</div>
            <button class="btn btn-outline-secondary" @onclick="GoBack">Back</button>
        </div>
    }
    else
    {
        <div class="restaurant-selection-card">
            <div class="selection-header">
                <div>
                    <h2 class="mb-1">Available Restaurants</h2>
                    <div class="text-muted small">
                        Pick <strong>1 to @MaxRestaurants</strong>. Your group members will be able to order from the selected restaurants.
                    </div>
                </div>

                <div class="selection-count">
                    <span class="count-badge">@selected.Count</span> selected
                </div>
            </div>

            <div class="restaurant-selection-grid">
                @foreach (var restaurant in restaurants)
                {
                    var isSelected = selected.Contains(restaurant.Id);
                    var isDisabled = !isSelected && selected.Count >= MaxRestaurants;

                    <div class="restaurant-select-card @(isSelected ? "selected" : "") @(isDisabled ? "opacity-50" : "")"
                         style="@(isDisabled ? "cursor:not-allowed;" : "cursor:pointer;")"
                         @onclick="async () => { if (!isDisabled) Toggle(restaurant.Id); await Task.CompletedTask; }">

                        <div class="select-checkbox">
                            @if (isSelected)
                            {
                                <i class="bi bi-check-circle-fill"></i>
                            }
                            else
                            {
                                <i class="bi bi-circle"></i>
                            }
                        </div>

                        <div class="restaurant-select-info">
                            <h3>@restaurant.Name</h3>
                            <div class="restaurant-meta">
                                <span>@restaurant.CuisineType</span>
                                @if (!string.IsNullOrEmpty(restaurant.LocationWithinMall))
                                {
                                    <span> • @restaurant.LocationWithinMall</span>
                                }
                            </div>

                            @if (restaurant.Rating > 0)
                            {
                                <div class="text-muted small mt-1">
                                    Rating: <strong>@restaurant.Rating.ToString("0.0")</strong> • Busy: <strong>@restaurant.BusyLevel</strong>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger mt-3 mb-0">@error</div>
            }

            <div class="action-buttons">
                <button class="btn-cancel" @onclick="GoBack" disabled="@isSaving">Back</button>

                <button class="btn-continue"
                        disabled="@(selected.Count == 0 || isSaving)"
                        @onclick="Finish">
                    @(isSaving
                        ? "Creating..."
                        : $"Continue with {selected.Count} Restaurant{(selected.Count != 1 ? "s" : "")}")
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int MallId { get; set; }

    private const int MaxRestaurants = 3;

    private List<Restaurant>? restaurants;
    private Mall? mall;

    private HashSet<int> selected = new();
    private bool isSaving;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();

        mall = await ctx.Mall.FirstOrDefaultAsync(m => m.Id == MallId);

        restaurants = await ctx.Restaurant
            .Where(r => r.MallId == MallId)
            .OrderBy(r => r.Name)
            .ToListAsync();
    }

    private void Toggle(int id)
    {
        error = null;

        if (selected.Contains(id))
        {
            selected.Remove(id);
            return;
        }

        if (selected.Count >= MaxRestaurants)
        {
            error = $"You can select up to {MaxRestaurants} restaurants only.";
            return;
        }

        selected.Add(id);
    }

    private void GoBack() => Nav.NavigateTo("/grouporders/selectmall");

    private async Task Finish()
    {
        if (isSaving) return;

        error = null;

        if (selected.Count < 1)
        {
            error = "Please select at least 1 restaurant.";
            return;
        }

        if (selected.Count > MaxRestaurants)
        {
            error = $"Please select at most {MaxRestaurants} restaurants.";
            return;
        }

        isSaving = true;

        try
        {
            var authState = await Auth.GetAuthenticationStateAsync();
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value
                        ?? authState.User.Identity?.Name;

            if (string.IsNullOrWhiteSpace(email))
            {
                error = "You must be logged in.";
                return;
            }

            await using var ctx = await DbFactory.CreateDbContextAsync();

            var domainUser = await ctx.User.FirstOrDefaultAsync(u => u.Email == email);
            if (domainUser == null)
            {
                domainUser = new User
                {
                    Name = email,
                    Email = email,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };

                ctx.User.Add(domainUser);
                await ctx.SaveChangesAsync();
            }

            var code = await GenerateUniqueCodeAsync(ctx);

            var now = DateTime.UtcNow;
            var groupOrder = new GroupOrder
            {
                GroupCode = code,
                CreatedTime = now,
                Status = "Active",

                // ✅ 15 minutes expiry
                ClosedTime = now.AddMinutes(15),

                MallId = MallId,
                UserId = domainUser.Id,
                DateCreated = now,
                DateUpdated = now,
                CreatedBy = email,
                UpdatedBy = email
            };

            ctx.GroupOrder.Add(groupOrder);
            await ctx.SaveChangesAsync();

            ctx.GroupOrderMember.Add(new GroupOrderMember
            {
                GroupOrderId = groupOrder.Id,
                UserId = domainUser.Id,
                JoinTime = now,
                Status = "Host",
                DateCreated = now,
                DateUpdated = now,
                CreatedBy = email,
                UpdatedBy = email
            });

            var restaurantIds = selected.Distinct().ToList();
            foreach (var rid in restaurantIds)
            {
                ctx.GroupOrderRestaurant.Add(new GroupOrderRestaurant
                {
                    GroupOrderId = groupOrder.Id,
                    RestaurantId = rid
                });
            }

            await ctx.SaveChangesAsync();

            GroupOrderState.Clear();
            GroupOrderState.GroupOrderId = groupOrder.Id;
            GroupOrderState.GroupCode = groupOrder.GroupCode;
            GroupOrderState.MallId = groupOrder.MallId;
            GroupOrderState.SelectedRestaurantIds = restaurantIds;

            Nav.NavigateTo($"/grouporders/lobby/{code}");
        }
        catch (Exception ex)
        {
            error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private static string GenerateCode()
        => Guid.NewGuid().ToString("N")[..6].ToUpperInvariant();

    private static async Task<string> GenerateUniqueCodeAsync(FoodDeliveryrestartContext ctx)
    {
        for (var attempt = 0; attempt < 10; attempt++)
        {
            var code = GenerateCode();
            var exists = await ctx.GroupOrder.AnyAsync(g => g.GroupCode == code);
            if (!exists) return code;
        }

        return Guid.NewGuid().ToString("N")[..8].ToUpperInvariant();
    }
}
