@page "/restaurants"
@rendermode InteractiveServer

@using System.Linq
@using Microsoft.EntityFrameworkCore
@using FoodDeliveryrestart.Domain
@using FoodDeliveryrestart.Data

@implements IAsyncDisposable

@inject IDbContextFactory<FoodDeliveryrestartContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>All Restaurants - Food Delivery</PageTitle>

<div class="restaurants-hero">
    <div class="hero-content">
        <h1>All Restaurants</h1>
        <p class="subtitle">Browse all available restaurants and their menus</p>

        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text"
                   class="search-input"
                   placeholder="Search restaurants by name or cuisine..."
                   @bind="searchText"
                   @bind:event="oninput" />
        </div>
    </div>
</div>

<div class="restaurants-container">
    @if (restaurants is null)
    {
        <p>Loading...</p>
    }
    else if (!FilteredRestaurants.Any())
    {
        <p>No restaurants found.</p>
    }
    else
    {
        <div class="restaurant-grid">
            @foreach (var restaurant in FilteredRestaurants)
            {
                var img = string.IsNullOrWhiteSpace(restaurant.ImageUrl) ? FallbackImage : restaurant.ImageUrl;
                var isLogo = IsLogoImage(img);

                <div class="restaurant-card" @onclick="() => ViewMenu(restaurant.Id)">
                    <div class="image-wrapper @(isLogo ? "is-logo" : "is-photo")">
                        <img src="@img"
                             alt="@restaurant.Name"
                             loading="lazy"
                             referrerpolicy="no-referrer"
                             onerror="this.onerror=null;this.src='@FallbackImage';" />
                    </div>

                    <div class="card-body">
                        <h3>@restaurant.Name</h3>

                        <span class="cuisine-badge">@restaurant.CuisineType</span>

                        <div class="meta-row">
                            <div class="rating">
                                <i class="bi bi-star-fill"></i>
                                <span>@restaurant.Rating.ToString("0.0")</span>
                            </div>

                            <div class="busy">
                                <span class="busy-dot @BusyDotClass(restaurant.BusyLevel)"></span>
                                <span>@restaurant.BusyLevel</span>
                            </div>
                        </div>

                        <div class="details">
                            <div>
                                <i class="bi bi-geo-alt"></i>
                                @FormatLocation(restaurant)
                            </div>
                            <div><i class="bi bi-clock"></i> @restaurant.OperatingHours</div>
                        </div>

                        <button class="view-menu-btn"
                                @onclick:stopPropagation="true"
                                @onclick="() => ViewMenu(restaurant.Id)">
                            View Menu
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private const string FallbackImage =
        "https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1600&q=70";

    private FoodDeliveryrestartContext? context;
    private List<Restaurant>? restaurants;
    private string searchText = "";

    private IEnumerable<Restaurant> FilteredRestaurants =>
        string.IsNullOrWhiteSpace(searchText)
            ? restaurants ?? Enumerable.Empty<Restaurant>()
            : restaurants!.Where(r =>
                (r.Name ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                (r.CuisineType ?? "").Contains(searchText, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();

        // ✅ IMPORTANT: load mall name too
        restaurants = context.Restaurant
            .Include(r => r.Mall)
            .OrderBy(r => r.Name)
            .ToList();
    }

    private void ViewMenu(int id) => NavigationManager.NavigateTo($"/restaurants/{id}/menu");

    // ✅ Show: "Tampines Mall • #01-24"
    private static string FormatLocation(Restaurant r)
    {
        var mallName = r.Mall?.MallName?.Trim();
        var unit = FormatUnit(r.LocationWithinMall);

        if (string.IsNullOrWhiteSpace(mallName))
            return unit ?? (r.LocationWithinMall ?? "");

        if (string.IsNullOrWhiteSpace(unit))
            return mallName;

        return $"{mallName} • {unit}";
    }

    // ✅ Formats: 1-24 -> #01-24, 8-9 -> #08-09, B2-3 -> #B2-03
    private static string? FormatUnit(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw))
            return null;

        raw = raw.Trim().TrimStart('#');

        var parts = raw.Split('-', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length != 2)
            return $"#{raw}"; // fallback for weird strings

        var left = FormatLeftPart(parts[0]);
        var right = parts[1].PadLeft(2, '0');

        return $"#{left}-{right}";
    }

    private static string FormatLeftPart(string left)
    {
        left = left.Trim();

        if (int.TryParse(left, out var n))
            return n.ToString("00");

        return left.ToUpper();
    }

    private static bool IsLogoImage(string url)
    {
        url = url.ToLowerInvariant();
        return url.Contains("upload.wikimedia.org") || url.Contains("logo");
    }

    private string BusyDotClass(BusyLevel level) => level switch
    {
        BusyLevel.Low => "low",
        BusyLevel.Medium => "medium",
        BusyLevel.High => "high",
        _ => "low"
    };

    public async ValueTask DisposeAsync()
    {
        if (context is not null)
            await context.DisposeAsync();
    }
}
