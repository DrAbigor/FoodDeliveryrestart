@page "/profile"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject AuthenticationStateProvider Auth
@inject NavigationManager Nav

<PageTitle>Profile</PageTitle>

<div class="profile-hero">
    <div class="hero-content">
        <h1>My Profile</h1>
        <p class="subtitle">Manage your account & access your orders.</p>
    </div>
</div>

<div class="profile-container">
    @if (loading)
    {
        <div class="cardish">Loading…</div>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="error">@error</div>
    }
    else
    {
        <div class="profile-grid">
            <div class="cardish">
                <h3>Account Information</h3>

                <div class="info-row">
                    <span class="label">Name</span>
                    <span class="value">@name</span>
                </div>
                <div class="info-row">
                    <span class="label">Email</span>
                    <span class="value">@email</span>
                </div>
                <div class="info-row">
                    <span class="label">Role</span>
                    <span class="value">@role</span>
                </div>
            </div>

            <div class="cardish">
                <h3>Quick Actions</h3>

                <div class="actions">
                    <button class="btn-primary" @onclick="GoRestaurants">
                        Browse Restaurants
                    </button>

                    <button class="btn-ghost" @onclick="GoMyGroupOrders">
                        My Group Orders
                    </button>

                    <button class="btn-ghost" @onclick="GoJoinGroup">
                        Join Group by Code
                    </button>

                    @if (isAdmin)
                    {
                        <button class="btn-ghost" @onclick="GoManageRestaurant">
                            Manage Restaurant
                        </button>
                        <button class="btn-ghost" @onclick="GoManageMenuItem">
                            Manage Menu Item
                        </button>
                    }

                    <button class="btn-danger" @onclick="Logout">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool loading = true;
    private string? error;

    private string name = "-";
    private string email = "-";
    private string role = "User";
    private bool isAdmin;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;

            if (user?.Identity?.IsAuthenticated != true)
            {
                error = "You are not logged in.";
                return;
            }

            email = user.FindFirst(ClaimTypes.Email)?.Value ?? user.Identity?.Name ?? "-";
            name = user.FindFirst("given_name")?.Value
                   ?? user.Identity?.Name
                   ?? "User";

            // Try to show roles from common claim types (ClaimTypes.Role and "role") and detect admin (case-insensitive)
            var roles = user.FindAll(ClaimTypes.Role).Select(r => r.Value)
                        .Concat(user.FindAll("role").Select(r => r.Value))
                        .Where(v => !string.IsNullOrWhiteSpace(v))
                        .Select(v => v.Trim())
                        .ToList();

            if (roles.Count > 0)
                role = roles[0];

            isAdmin = roles.Any(r => string.Equals(r, "Administrator", StringComparison.OrdinalIgnoreCase))
                      || user.IsInRole("Administrator");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private void GoRestaurants() => Nav.NavigateTo("/restaurants");
    private void GoMyGroupOrders() => Nav.NavigateTo("/grouporders/my");
    private void GoJoinGroup() => Nav.NavigateTo("/grouporders/join");
    private void GoManageRestaurant() => Nav.NavigateTo("/admin/manage-restaurant");
    private void GoManageMenuItem() => Nav.NavigateTo("/admin/manage-menu-item");

    // Identity default logout endpoint (works if Identity is set up normally)
    private void Logout() => Nav.NavigateTo("/auth/logout", forceLoad: true);

}
