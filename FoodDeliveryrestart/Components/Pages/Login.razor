@page "/login"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data

@inject UserManager<FoodDeliveryrestartUser> UserManager
@inject SignInManager<FoodDeliveryrestartUser> SignInManager
@inject IJSRuntime JS

<div class="auth-page">
    <div class="auth-card">
        <h2 class="auth-title">Login</h2>
        <p class="auth-sub">Welcome back! Please sign in.</p>

        <label class="auth-label">Email</label>
        <input class="auth-input" @bind="Email" placeholder="name@email.com" />

        <label class="auth-label">Password</label>
        <input class="auth-input" type="password" @bind="Password" placeholder="••••••••" />

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <div class="auth-error">@Error</div>
        }

        @if (!string.IsNullOrWhiteSpace(DebugInfo))
        {
            <div style="color: blue; margin: 10px 0;">@DebugInfo</div>
        }

        <button class="auth-btn" @onclick="DoLogin" disabled="@IsLoading">
            @(IsLoading ? "Logging in..." : "Login")
        </button>

        <!-- ✅ Forgot password link -->
        <div class="auth-footer" style="margin-top:10px;">
            <a class="auth-link" href="/forgot-password">Forgot password?</a>
        </div>

        <div class="auth-footer">
            Don't have an account?
            <a class="auth-link" href="/register">Register</a>
        </div>

        <!-- ✅ this is required for your cookie-setting POST -->
        <script src="/login-post.js"></script>
    </div>
</div>

@code {
    private string Email = "";
    private string Password = "";
    private string Error = "";
    private string DebugInfo = "";
    private bool IsLoading = false;

    private async Task DoLogin()
    {
        DebugInfo = $"Login clicked at {DateTime.Now:HH:mm:ss}";
        Error = "";
        IsLoading = true;
        StateHasChanged();

        try
        {
            await Task.Delay(100); // Small delay to ensure UI updates

            if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
            {
                Error = "Please enter email and password.";
                return;
            }

            DebugInfo = "Finding user...";
            StateHasChanged();

            var user = await UserManager.FindByEmailAsync(Email.Trim());
            if (user == null)
            {
                Error = "Invalid email or password.";
                DebugInfo = "User not found in database.";
                return;
            }

            DebugInfo = "Checking password...";
            StateHasChanged();

            var result = await SignInManager.CheckPasswordSignInAsync(user, Password, false);

            if (result.Succeeded)
            {
                // ✅ IMPORTANT:
                // We do a full browser POST to /auth/login so Identity cookie is set in HTTP response.
                await JS.InvokeVoidAsync("submitLoginForm", Email, Password);
                return; // browser will navigate after POST
            }

            Error = "Invalid email or password.";
            DebugInfo = $"Login failed. Result: {result}";
        }
        catch (Exception ex)
        {
            Error = $"An error occurred: {ex.Message}";
            DebugInfo = $"Exception: {ex}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
}
