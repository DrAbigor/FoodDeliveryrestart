@page "/forgot-password"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data
@using System.Net

@inject UserManager<FoodDeliveryrestartUser> UserManager
<link rel="stylesheet" href="/css/login.css" />

<div class="auth-page">
    <div class="auth-card">
        <div class="logo-container">
            <div class="app-logo">FoodLeh?</div>
            <div class="app-tagline">Your favorite meals, delivered fast</div>
        </div>
        <h2 class="auth-title">Forgot Password</h2>
        <p class="auth-sub">Enter your email. We’ll generate a reset link.</p>

        <label class="auth-label">Email</label>
        <input class="auth-input" @bind="Email" placeholder="name@email.com" />

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <div class="auth-error">@Error</div>
        }
        @if (!string.IsNullOrWhiteSpace(Success))
        {
            <div class="auth-success">@Success</div>
        }

        @* ✅ DEV: show reset link here *@
        @if (!string.IsNullOrWhiteSpace(DevResetLink))
        {
            <div class="auth-success" style="margin-top:10px;">
                <div style="font-weight:600;">DEV Reset link:</div>
                <a class="auth-link" href="@DevResetLink">@DevResetLink</a>
            </div>
        }

        <button class="auth-btn" @onclick="SendReset" disabled="@IsLoading">
            @(IsLoading ? "Sending..." : "Send reset link")
        </button>

        <div class="auth-footer">
            <a class="auth-link" href="/login">Back to login</a>
        </div>
    </div>
</div>

@code {
    private string Email = "";
    private string? Error;
    private string? Success;
    private string? DevResetLink;   // ✅ add
    private bool IsLoading;

    private async Task SendReset()
    {
        Error = null;
        Success = null;
        DevResetLink = null;

        if (string.IsNullOrWhiteSpace(Email))
        {
            Error = "Please enter your email.";
            return;
        }

        IsLoading = true;

        try
        {
            var trimmed = Email.Trim();
            var user = await UserManager.FindByEmailAsync(trimmed);

            // ✅ security best practice: always show same message
            Success = "If an account exists, a reset link will be sent.";

            // ✅ DEV ONLY: generate token + show link
            if (user != null && !string.IsNullOrWhiteSpace(user.Email))
            {
                var token = await UserManager.GeneratePasswordResetTokenAsync(user);

                // Token can contain + / = etc. Must URL-encode.
                var encodedToken = WebUtility.UrlEncode(token);
                var encodedEmail = WebUtility.UrlEncode(user.Email);

                DevResetLink = $"/reset-password?email={encodedEmail}&token={encodedToken}";
            }
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }
}
