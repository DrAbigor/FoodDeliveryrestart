@page "/profile"
@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@inject UserManager<FoodDeliveryrestartUser> UserManager
@inject FoodDeliveryrestart.Services.CustomAuthenticationStateProvider AuthStateProvider
@inject SignInManager<FoodDeliveryrestartUser> SignInManager
@inject NavigationManager Nav

<PageTitle>Profile - Food Delivery</PageTitle>

<div class="profile-page">
    @if (CurrentUser != null)
    {
        <div class="profile-container">
            <!-- Profile Header Card -->
            <div class="profile-header-card @(IsAdmin ? "admin-theme" : "")">
                <div class="profile-avatar">
                    @GetInitials()
                </div>
                <div class="profile-info">
                    <h1 class="profile-name">@CurrentUser.FirstName @CurrentUser.LastName</h1>
                    <p class="profile-email">@CurrentUser.Email</p>
                    @if (IsAdmin)
                    {
                        <div class="role-badge admin-badge">
                            <i class="bi bi-shield-fill-check"></i>
                            Administrator
                        </div>
                    }
                    else
                    {
                        <div class="role-badge user-badge">
                            <i class="bi bi-person-fill"></i>
                            User
                        </div>
                    }
                </div>
            </div>

            <!-- Account Details Card -->
            <div class="detail-card">
                <h2 class="card-title">Account Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">First Name</span>
                        <span class="info-value">@CurrentUser.FirstName</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Name</span>
                        <span class="info-value">@CurrentUser.LastName</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email Address</span>
                        <span class="info-value">@CurrentUser.Email</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Account Role</span>
                        <span class="info-value">@string.Join(", ", UserRoles)</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            @if (IsAdmin)
            {
                <div class="detail-card admin-actions-card">
                    <h2 class="card-title">
                        <i class="bi bi-lightning-fill"></i>
                        Admin Quick Actions
                    </h2>
                    <div class="actions-grid">
                        <button class="action-button" @onclick='() => Nav.NavigateTo("/restaurants")'>
                            <div class="action-icon">🍽️</div>
                            <div class="action-text">
                                <div class="action-title">Manage Restaurants</div>
                                <div class="action-desc">View and edit restaurants</div>
                            </div>
                        </button>
                        <button class="action-button" @onclick='() => Nav.NavigateTo("/")'>
                            <div class="action-icon">🏠</div>
                            <div class="action-text">
                                <div class="action-title">Dashboard</div>
                                <div class="action-desc">View main dashboard</div>
                            </div>
                        </button>
                        <button class="action-button" @onclick='() => Nav.NavigateTo("/group-orders")'>
                            <div class="action-icon">👥</div>
                            <div class="action-text">
                                <div class="action-title">Group Orders</div>
                                <div class="action-desc">Manage group orders</div>
                            </div>
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="detail-card">
                    <h2 class="card-title">Quick Actions</h2>
                    <div class="actions-grid">
                        <button class="action-button" @onclick='() => Nav.NavigateTo("/restaurants")'>
                            <div class="action-icon">🍽️</div>
                            <div class="action-text">
                                <div class="action-title">Browse Restaurants</div>
                                <div class="action-desc">Discover amazing food</div>
                            </div>
                        </button>
                        <button class="action-button" @onclick='() => Nav.NavigateTo("/group-orders")'>
                            <div class="action-icon">👥</div>
                            <div class="action-text">
                                <div class="action-title">My Group Orders</div>
                                <div class="action-desc">View your orders</div>
                            </div>
                        </button>
                    </div>
                </div>
            }

            <!-- Logout Button -->
            <div class="logout-section">
                <button class="logout-button" @onclick="HandleLogout">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading your profile...</p>
        </div>
    }
</div>

@code {
    private FoodDeliveryrestartUser? CurrentUser;
    private IList<string> UserRoles = new List<string>();
    private bool IsAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var userId = await AuthStateProvider.GetUserId();
        if (!string.IsNullOrEmpty(userId))
        {
            CurrentUser = await UserManager.FindByIdAsync(userId);
            if (CurrentUser != null)
            {
                UserRoles = await UserManager.GetRolesAsync(CurrentUser);
                IsAdmin = UserRoles.Contains("Administrator");
            }
        }
    }

    private string GetInitials()
    {
        if (CurrentUser == null) return "?";

        var first = !string.IsNullOrEmpty(CurrentUser.FirstName) ? CurrentUser.FirstName[0].ToString() : "";
        var last = !string.IsNullOrEmpty(CurrentUser.LastName) ? CurrentUser.LastName[0].ToString() : "";
        return (first + last).ToUpper();
    }

    private async Task HandleLogout()
    {
        // Mark Blazor auth state as logged out and perform a full server logout
        AuthStateProvider.MarkUserAsLoggedOut();
        Nav.NavigateTo("/auth/logout", forceLoad: true);
    }
}