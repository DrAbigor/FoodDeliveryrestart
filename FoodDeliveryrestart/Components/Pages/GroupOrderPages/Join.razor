@page "/grouporders/join"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using FoodDeliveryrestart.Data
@using FoodDeliveryrestart.Domain

@inject IDbContextFactory<FoodDeliveryrestartContext> DbFactory
@inject AuthenticationStateProvider Auth
@inject NavigationManager Nav
@inject FoodDeliveryrestart.Services.GroupOrderState GroupOrderState

<PageTitle>Join Group Order</PageTitle>

<div class="join-page">
    <div class="join-hero">
        <h1>Join Group Order</h1>
        <p class="muted">Enter a group code to join your friends and order together.</p>
    </div>

    <div class="cardish join-card">
        <div class="field">
            <label class="label">Group code</label>

            <input class="code-input"
                   value="@CodeInput"
                   @oninput="OnCodeInput"
                   placeholder="e.g. G8K2P7"
                   maxlength="8"
                   autocomplete="off" />

            <div class="help muted">
                Tip: Codes are not case-sensitive. We’ll auto-format it for you.
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <div class="alert-error">@Error</div>
        }

        <div class="actions">
            <a class="btn-outline" href="/grouporders/selectmall">Back</a>

            <button class="btn-primary"
                    disabled="@IsBusy"
                    @onclick="JoinGroup">
                @(IsBusy ? "Joining..." : "Join")
            </button>
        </div>
    </div>
</div>

@code
{
    // supports: /grouporders/join?code=XXXX
    [SupplyParameterFromQuery(Name = "code")]
    public string? CodeQuery { get; set; }

    private string CodeInput = "";
    private string? Error;
    private bool IsBusy;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(CodeQuery))
        {
            CodeInput = Normalize(CodeQuery);
        }
    }

    private void OnCodeInput(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString() ?? "";
        CodeInput = Normalize(raw);
    }

    private static string Normalize(string raw)
        => (raw ?? "")
            .Trim()
            .Replace(" ", "")
            .ToUpperInvariant();

    private async Task JoinGroup()
    {
        if (IsBusy) return;

        Error = null;
        var trimmed = Normalize(CodeInput);

        if (string.IsNullOrWhiteSpace(trimmed))
        {
            Error = "Please enter a group code.";
            return;
        }

        IsBusy = true;

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();

            var groupOrder = await ctx.GroupOrder
                .FirstOrDefaultAsync(g => g.GroupCode == trimmed);

            if (groupOrder == null)
            {
                Error = "Invalid code. Please check and try again.";
                return;
            }

            // Block join if not Active
            var status = (groupOrder.Status ?? "").Trim();
            if (!status.Equals("Active", StringComparison.OrdinalIgnoreCase))
            {
                Error = $"This group is {status}. You can’t join right now.";
                return;
            }

            // OPTIONAL cutoff check (only if your GroupOrder has ClosedTime)
            // If you get a compile error here, tell me and I'll remove this block.
            if (groupOrder.ClosedTime != default && DateTime.UtcNow > groupOrder.ClosedTime)
            {
                Error = "This group order has expired. Ask the host to create a new one.";
                return;
            }

            // Get current logged-in user email
            var authState = await Auth.GetAuthenticationStateAsync();
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value
                        ?? authState.User.Identity?.Name;

            if (string.IsNullOrWhiteSpace(email))
            {
                Error = "You must be logged in to join a group order.";
                return;
            }

            // Map Identity email -> Domain User
            var domainUser = await ctx.User.FirstOrDefaultAsync(u => u.Email == email);
            if (domainUser == null)
            {
                domainUser = new User
                {
                    Name = email,
                    Email = email,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };

                ctx.User.Add(domainUser);
                await ctx.SaveChangesAsync();
            }

            // Prevent duplicate join
            var alreadyMember = await ctx.GroupOrderMember.AnyAsync(m =>
                m.GroupOrderId == groupOrder.Id && m.UserId == domainUser.Id);

            if (!alreadyMember)
            {
                ctx.GroupOrderMember.Add(new GroupOrderMember
                {
                    GroupOrderId = groupOrder.Id,
                    UserId = domainUser.Id,
                    JoinTime = DateTime.UtcNow,
                    Status = "Member",
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                });

                await ctx.SaveChangesAsync();
            }

            // Store active group order in state
            GroupOrderState.GroupOrderId = groupOrder.Id;
            GroupOrderState.GroupCode = groupOrder.GroupCode;
            GroupOrderState.MallId = groupOrder.MallId;

            Nav.NavigateTo($"/grouporders/lobby/{trimmed}");
        }
        catch (Exception ex)
        {
            Error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            IsBusy = false;
        }
    }
}
