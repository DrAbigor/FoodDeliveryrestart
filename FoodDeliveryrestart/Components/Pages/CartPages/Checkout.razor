@page "/checkout"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FoodDeliveryrestart.Domain

@inject FoodDeliveryrestart.Services.CartService CartSvc
@inject FoodDeliveryrestart.Services.GroupOrderState GroupOrderState
@inject IDbContextFactory<FoodDeliveryrestart.Data.FoodDeliveryrestartContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth

<PageTitle>Checkout</PageTitle>

<div class="checkout-wrap">

    <div class="checkout-hero">
        <div class="hero-content">
            <h1>Checkout</h1>
            <p class="muted">Confirm payment and place your order.</p>

            @if (GroupOrderState.GroupOrderId > 0 && !string.IsNullOrWhiteSpace(GroupOrderState.GroupCode))
            {
                <div class="pill" style="margin-top:10px;">
                    Group Code: <strong>@GroupOrderState.GroupCode</strong>
                </div>
            }
        </div>
    </div>

    <div class="checkout-container">

        @if (!CartSvc.Items.Any())
        {
            <div class="empty-card">
                <h3>Your cart is empty</h3>
                <p class="muted">Add items from Restaurants to proceed.</p>
                <button class="btn-primary" @onclick="GoRestaurants">Back to restaurants</button>
            </div>
        }
        else if (IsSaving)
        {
            <div class="empty-card">
                <h3>Placing your order…</h3>
                <p class="muted">Please wait.</p>
            </div>
        }
        else
        {
            <div class="checkout-grid">

                <!-- LEFT: Payment -->
                <div class="panel">
                    <div class="panel-head">
                        <h3>Payment</h3>
                        <div class="pill">Secure</div>
                    </div>

                    <label class="label">Payment Method</label>
                    <select class="select" @bind="SelectedPaymentType">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                    </select>

                    @if (SelectedPaymentType == "Card")
                    {
                        <div class="mini muted" style="margin-top:8px;">Enter card details:</div>
                        <div class="form-grid" style="margin-top:8px; gap:8px; display:grid; grid-template-columns: 1fr 1fr;">
                            <div style="grid-column: span 2;">
                                <label class="label">Card Type</label>
                                <select class="select" @bind="NewCardType">
                                    <option value="">-- Select card type --</option>
                                    <option>Visa</option>
                                    <option>MasterCard</option>
                                    <option>AMEX</option>
                                </select>
                            </div>
                            <div style="grid-column: span 2;">
                                <label class="label">Card Number</label>
                                <input class="input" type="text" inputmode="numeric" autocomplete="cc-number"
                                       placeholder="1234 5678 9012 3456" @bind="NewCardNumber" />
                            </div>
                            <div>
                                <label class="label">Expiry Month</label>
                                <input class="input" type="number" min="1" max="12" @bind="NewExpiryMonth" />
                            </div>
                            <div>
                                <label class="label">Expiry Year</label>
                                <input class="input" type="number" min="2024" max="2100" @bind="NewExpiryYear" />
                            </div>
                            <div style="grid-column: span 2;">
                                <label class="label">Cardholder Name</label>
                                <input class="input" type="text" @bind="NewCardHolderName" />
                            </div>
                        </div>
                    }

                    <div class="actions">
                        <button class="btn-primary" @onclick="PlaceOrder">Pay &amp; Place Order</button>
                        <button class="btn-ghost" @onclick="GoCart">Back to cart</button>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(Error))
                    {
                        <div class="error">@Error</div>
                    }
                </div>

                <!-- RIGHT: Summary -->
                <div class="panel">
                    <div class="panel-head">
                        <h3>Order Summary</h3>
                        <div class="pill">@CartSvc.Count() item(s)</div>
                    </div>

                    <!-- Voucher Section -->
                    <div class="voucher-section">
                        <label class="label">
                            <i class="bi bi-ticket-perforated"></i> Add Voucher
                        </label>

                        @if (userVouchers.Any())
                        {
                            <select class="select voucher-select"
                                    @bind="SelectedVoucherId"
                                    @bind:after="OnVoucherChanged">
                                <option value="0">-- Select a voucher --</option>

                                @foreach (var uv in userVouchers)
                                {
                                    <option value="@uv.Id">
                                        @uv.Voucher?.Name
                                        (
                                        @(
                                            uv.Voucher?.DiscountType == "Percentage"
                                                ? $"{uv.Voucher?.DiscountValue}% OFF"
                                                : uv.Voucher?.DiscountType == "FreeDelivery"
                                                    ? "Free Delivery"
                                                    : $"${uv.Voucher?.DiscountValue} OFF"
                                         )
                                        )
                                    </option>
                                }
                            </select>

                            @if (selectedVoucher != null)
                            {
                                <div class="voucher-applied">
                                    <i class="bi bi-check-circle-fill"></i>
                                    <span>@selectedVoucher.Voucher?.Name applied!</span>
                                    <button class="voucher-remove" @onclick="RemoveVoucher" type="button">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-vouchers">
                                <span>No vouchers available</span>
                                <a href="/vouchers" class="voucher-link">Claim vouchers →</a>
                            </div>
                        }
                    </div>

                    <div class="rows">
                        <div class="row">
                            <span>Subtotal</span>
                            <span>$@CartSvc.Subtotal().ToString("0.00")</span>
                        </div>

                        <div class="row">
                            <span>Delivery Fee</span>

                            @if (IsFreeDeliveryApplied())
                            {
                                <span class="discount-applied">
                                    <span class="strikethrough">$@CartSvc.DeliveryFee.ToString("0.00")</span>
                                    <span class="free">FREE</span>
                                </span>
                            }
                            else
                            {
                                <span>$@CartSvc.DeliveryFee.ToString("0.00")</span>
                            }
                        </div>

                        <div class="row">
                            <span>Tip</span>
                            <span>$@CartSvc.Tip.ToString("0.00")</span>
                        </div>

                        @if (voucherDiscount > 0)
                        {
                            <div class="row discount-row">
                                <span><i class="bi bi-tag-fill"></i> Voucher Discount</span>
                                <span class="discount-value">-$@voucherDiscount.ToString("0.00")</span>
                            </div>
                        }

                        <div class="divider"></div>

                        <div class="row total">
                            <span>Total</span>
                            <span>$@CalculateTotal().ToString("0.00")</span>
                        </div>
                    </div>

                    <div class="mini">
                        <div class="mini-title">Items</div>
                        @foreach (var item in CartSvc.Items)
                        {
                            <div class="mini-item">
                                <div class="mini-name">@item.ItemName</div>
                                <div class="mini-meta">@item.Quantity × $@item.Price.ToString("0.00")</div>
                                <div class="mini-total">$@((item.Quantity * item.Price).ToString("0.00"))</div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        }

    </div>
</div>

@code {
    private bool IsSaving;
    private string? Error;

    private string SelectedPaymentType = "Cash";
    private string? NewCardType;
    private string? NewCardNumber;
    private int NewExpiryMonth;
    private int NewExpiryYear;
    private string? NewCardHolderName;

    // Voucher state
    private string? userId;
    private List<UserVoucher> userVouchers = new();
    private int SelectedVoucherId = 0;
    private UserVoucher? selectedVoucher;
    private decimal voucherDiscount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Identity user id (string)
        var state = await Auth.GetAuthenticationStateAsync();
        var user = state.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        // Load user's available vouchers (not used)
        if (!string.IsNullOrWhiteSpace(userId))
        {
            userVouchers = await db.UserVoucher
                .Include(uv => uv.Voucher)
                .Where(uv => uv.UserId == userId && !uv.IsUsed)
                .ToListAsync();
        }

        SelectedPaymentType = "Cash";
    }

    private void OnVoucherChanged()
    {
        selectedVoucher = userVouchers.FirstOrDefault(uv => uv.Id == SelectedVoucherId);
        CalculateVoucherDiscount();
    }

    private void RemoveVoucher()
    {
        SelectedVoucherId = 0;
        selectedVoucher = null;
        voucherDiscount = 0;
    }

    private void CalculateVoucherDiscount()
    {
        voucherDiscount = 0;

        if (selectedVoucher?.Voucher == null) return;

        var voucher = selectedVoucher.Voucher;
        var subtotal = CartSvc.Subtotal();

        // Minimum order check
        if (voucher.MinimumOrder.HasValue && subtotal < voucher.MinimumOrder.Value)
        {
            return;
        }

        switch (voucher.DiscountType)
        {
            case "Percentage":
                voucherDiscount = subtotal * (voucher.DiscountValue / 100m);
                break;

            case "Fixed":
                voucherDiscount = voucher.DiscountValue;
                break;

            case "FreeDelivery":
                voucherDiscount = 0;
                break;
        }
    }

    private bool IsFreeDeliveryApplied()
    {
        var subtotal = CartSvc.Subtotal();

        return selectedVoucher?.Voucher?.DiscountType == "FreeDelivery"
               && subtotal >= (selectedVoucher.Voucher.MinimumOrder ?? 0);
    }

    private decimal CalculateTotal()
    {
        var subtotal = CartSvc.Subtotal();
        var deliveryFee = CartSvc.DeliveryFee;
        var tip = CartSvc.Tip;

        if (IsFreeDeliveryApplied())
        {
            deliveryFee = 0;
        }

        return subtotal + deliveryFee + tip - voucherDiscount;
    }

    private void GoRestaurants() => Nav.NavigateTo("/restaurants");
    private void GoCart() => Nav.NavigateTo("/cart");

    private static DateTime ToUtcSafe(DateTime dt)
    {
        return dt.Kind switch
        {
            DateTimeKind.Utc => dt,
            DateTimeKind.Local => dt.ToUniversalTime(),
            _ => DateTime.SpecifyKind(dt, DateTimeKind.Utc)
        };
    }

    private async Task PlaceOrder()
    {
        Error = null;

        // Must be logged in
        var authState = await Auth.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(ClaimTypes.Email)?.Value
                    ?? authState.User.Identity?.Name;

        if (string.IsNullOrWhiteSpace(email))
        {
            Error = "You must be logged in to place an order.";
            return;
        }

        var useCard = SelectedPaymentType == "Card";
        if (useCard)
        {
            if (string.IsNullOrWhiteSpace(NewCardType) ||
                string.IsNullOrWhiteSpace(NewCardHolderName) ||
                NewExpiryMonth < 1 || NewExpiryMonth > 12 ||
                NewExpiryYear < DateTime.UtcNow.Year)
            {
                Error = "Please enter valid card details (type, name, expiry).";
                return;
            }

            var digits = new string((NewCardNumber ?? string.Empty).Where(char.IsDigit).ToArray());
            if (string.IsNullOrWhiteSpace(digits) || digits.Length < 12 || digits.Length > 19)
            {
                Error = "Please enter a valid card number.";
                return;
            }
        }

        IsSaving = true;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Map Identity email -> Domain.User
            var domainUser = await db.User.FirstOrDefaultAsync(u => u.Email == email);
            if (domainUser == null)
            {
                domainUser = new User
                {
                    Name = email,
                    Email = email,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };
                db.User.Add(domainUser);
                await db.SaveChangesAsync();
            }

            // Decide which GroupOrderId to use
            int groupOrderId;

            if (GroupOrderState.GroupOrderId > 0)
            {
                var g = await db.GroupOrder.FirstOrDefaultAsync(x => x.Id == GroupOrderState.GroupOrderId);
                if (g == null)
                {
                    Error = "Group order not found. Please re-join the group.";
                    return;
                }

                var status = (g.Status ?? "Active").Trim();
                var expired = g.ClosedTime.HasValue && DateTime.UtcNow > ToUtcSafe(g.ClosedTime.Value);

                if (expired || !status.Equals("Active", StringComparison.OrdinalIgnoreCase))
                {
                    Error = "This group order is closed. You cannot checkout now.";
                    return;
                }

                groupOrderId = g.Id;
            }
            else
            {
                // Solo checkout fallback
                var firstRestaurantId = CartSvc.Items.First().RestaurantId;
                var mallId = await db.Restaurant
                    .Where(r => r.Id == firstRestaurantId)
                    .Select(r => r.MallId)
                    .FirstOrDefaultAsync();

                if (mallId == 0) mallId = 1;

                var solo = new GroupOrder
                {
                    GroupCode = $"SOLO-{Guid.NewGuid():N}".Substring(0, 12),
                    CreatedTime = DateTime.UtcNow,
                    Status = "Solo",
                    MallId = mallId,
                    UserId = domainUser.Id,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };

                db.GroupOrder.Add(solo);
                await db.SaveChangesAsync();

                groupOrderId = solo.Id;
            }

            // ✅ Start tracking fields NOW so DB won't insert NULL
            var trackingNow = DateTime.UtcNow;

            // Create Order
            var order = new Order
            {
                DateTime = trackingNow,
                Status = "Paid",
                TotalAmount = CalculateTotal(),
                UserId = domainUser.Id,
                GroupOrderId = groupOrderId,

                // ✅ FIX: non-null DeliveryStage + avoid int->byte cast issues
                DeliveryStage = (byte)0,
                DeliveryStartedUtc = trackingNow,
                DeliveryStageUpdatedUtc = trackingNow
            };

            db.Order.Add(order);
            await db.SaveChangesAsync();

            // OrderItems
            foreach (var ci in CartSvc.Items)
            {
                db.OrderItem.Add(new OrderItem
                {
                    OrderId = order.Id,
                    ItemId = ci.MenuItemId,
                    Quantity = ci.Quantity,
                    ItemPrice = ci.Price,
                    Subtotal = ci.Price * ci.Quantity
                });
            }

            // Mark voucher as used only if applicable
            if (selectedVoucher?.Voucher != null && !string.IsNullOrWhiteSpace(userId))
            {
                var subtotal = CartSvc.Subtotal();
                var min = selectedVoucher.Voucher.MinimumOrder ?? 0;
                var applicable = subtotal >= min;

                if (applicable)
                {
                    var uvToUpdate = await db.UserVoucher.FindAsync(selectedVoucher.Id);
                    if (uvToUpdate != null)
                    {
                        uvToUpdate.IsUsed = true;
                        uvToUpdate.UsedAt = DateTime.UtcNow;
                        uvToUpdate.OrderId = order.Id;
                        uvToUpdate.DateUpdated = DateTime.UtcNow;
                    }
                }
            }

            // PaymentMethod
            int paymentMethodId;

            if (!useCard)
            {
                var cashPm = await db.PaymentMethod
                    .FirstOrDefaultAsync(x => x.UserId == domainUser.Id && x.CardType == "Cash");

                if (cashPm is null)
                {
                    cashPm = new PaymentMethod
                    {
                        CardType = "Cash",
                        ExpiryMonth = 0,
                        ExpiryYear = 0,
                        CardHolderName = "Cash",
                        UserId = domainUser.Id,
                        DateCreated = DateTime.UtcNow,
                        DateUpdated = DateTime.UtcNow,
                        CreatedBy = email,
                        UpdatedBy = email
                    };

                    db.PaymentMethod.Add(cashPm);
                    await db.SaveChangesAsync();
                }

                paymentMethodId = cashPm.Id;
            }
            else
            {
                var pm = new PaymentMethod
                {
                    CardType = NewCardType,
                    ExpiryMonth = NewExpiryMonth,
                    ExpiryYear = NewExpiryYear,
                    CardHolderName = NewCardHolderName,
                    UserId = domainUser.Id,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };

                db.PaymentMethod.Add(pm);
                await db.SaveChangesAsync();

                paymentMethodId = pm.Id;
            }

            // Payment
            db.Payment.Add(new Payment
            {
                Name = useCard ? "Card Payment" : "Cash Payment",
                PaymentDate = DateTime.UtcNow,
                PaymentStatus = "Paid",
                Amount = order.TotalAmount,
                OrderId = order.Id,
                PaymentMethodId = paymentMethodId,
                UserId = domainUser.Id,
                DateCreated = DateTime.UtcNow,
                DateUpdated = DateTime.UtcNow,
                CreatedBy = email,
                UpdatedBy = email
            });

            await db.SaveChangesAsync();

            // ✅ Clear cart (badge should update now because DI is fixed)
            CartSvc.Clear();

            // ✅ IMPORTANT: go receipt first
            Nav.NavigateTo($"/orders/{order.Id}");
        }
        catch (Exception ex)
        {
            Error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            IsSaving = false;
        }
    }
}
