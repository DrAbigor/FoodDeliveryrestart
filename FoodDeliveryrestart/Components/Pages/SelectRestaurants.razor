@page "/grouporders/malls/{MallId:int}/restaurants"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using FoodDeliveryrestart.Domain
@using FoodDeliveryrestart.Data

@inject IDbContextFactory<FoodDeliveryrestartContext> DbFactory
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@inject FoodDeliveryrestart.Services.GroupOrderState GroupOrderState

<PageTitle>Select Restaurants - Group Order</PageTitle>

<div class="group-order-hero">
    <div class="hero-content">
        <h1>Select Restaurants</h1>
        @if (mall != null)
        {
            <p class="subtitle">Choose restaurants from @mall.MallName</p>
        }
    </div>
</div>

<div class="group-order-container">
    @if (restaurants is null)
    {
        <p>Loading restaurants...</p>
    }
    else if (!restaurants.Any())
    {
        <p>No restaurants available.</p>
        <button class="btn-cancel" @onclick="GoBack">Back</button>
    }
    else
    {
        <div class="restaurant-selection-card">
            <div class="selection-header">
                <h2>Available Restaurants</h2>
                <div class="selection-count">
                    <span class="count-badge">@selected.Count</span> selected
                </div>
            </div>

            <div class="restaurant-selection-grid">
                @foreach (var restaurant in restaurants)
                {
                    var isSelected = selected.Contains(restaurant.Id);

                    <div class="restaurant-select-card @(isSelected ? "selected" : "")"
                         @onclick="() => Toggle(restaurant.Id)">
                        <div class="select-checkbox">
                            @if (isSelected)
                            {
                                <i class="bi bi-check-circle-fill"></i>
                            }
                            else
                            {
                                <i class="bi bi-circle"></i>
                            }
                        </div>

                        <div class="restaurant-select-info">
                            <h3>@restaurant.Name</h3>
                            <div class="restaurant-meta">
                                <span>@restaurant.CuisineType</span>
                                @if (!string.IsNullOrEmpty(restaurant.LocationWithinMall))
                                {
                                    <span> • @restaurant.LocationWithinMall</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="text-danger mt-3">@error</div>
            }

            <div class="action-buttons">
                <button class="btn-cancel" @onclick="GoBack" disabled="@isSaving">Back</button>

                <button class="btn-continue"
                        disabled="@(!selected.Any() || isSaving)"
                        @onclick="Finish">
                    @(isSaving
                        ? "Creating..."
                        : $"Continue with {selected.Count} Restaurant{(selected.Count != 1 ? "s" : "")}")
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int MallId { get; set; }

    private List<Restaurant>? restaurants;
    private Mall? mall;

    private HashSet<int> selected = new();
    private bool isSaving;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();

        mall = await ctx.Mall.FirstOrDefaultAsync(m => m.Id == MallId);

        restaurants = await ctx.Restaurant
            .Where(r => r.MallId == MallId)
            .OrderBy(r => r.Name)
            .ToListAsync();
    }

    private void Toggle(int id)
    {
        if (!selected.Add(id))
            selected.Remove(id);
    }

    private void GoBack() => Nav.NavigateTo("/grouporders/selectmall");

    private async Task Finish()
    {
        // ✅ prevents double-click duplicate insert
        if (isSaving) return;

        error = null;

        if (!selected.Any())
            return;

        isSaving = true;

        try
        {
            // 1) Get logged-in user email
            var authState = await Auth.GetAuthenticationStateAsync();
            var email = authState.User.FindFirst(ClaimTypes.Email)?.Value
                        ?? authState.User.Identity?.Name;

            if (string.IsNullOrWhiteSpace(email))
            {
                error = "You must be logged in.";
                return;
            }

            await using var ctx = await DbFactory.CreateDbContextAsync();

            // 2) Map Identity email -> Domain.User
            var domainUser = await ctx.User.FirstOrDefaultAsync(u => u.Email == email);
            if (domainUser == null)
            {
                domainUser = new User
                {
                    Name = email,
                    Email = email,
                    DateCreated = DateTime.UtcNow,
                    DateUpdated = DateTime.UtcNow,
                    CreatedBy = email,
                    UpdatedBy = email
                };

                ctx.User.Add(domainUser);
                await ctx.SaveChangesAsync();
            }

            // 3) Create GroupOrder
            var code = GenerateCode();

            var groupOrder = new GroupOrder
            {
                GroupCode = code,
                CreatedTime = DateTime.UtcNow,
                Status = "Active",
                MallId = MallId,
                UserId = domainUser.Id,
                DateCreated = DateTime.UtcNow,
                DateUpdated = DateTime.UtcNow,
                CreatedBy = email,
                UpdatedBy = email
            };

            ctx.GroupOrder.Add(groupOrder);
            await ctx.SaveChangesAsync();

            // 4) Add creator as member (Host)
            ctx.GroupOrderMember.Add(new GroupOrderMember
            {
                GroupOrderId = groupOrder.Id,
                UserId = domainUser.Id,
                JoinTime = DateTime.UtcNow,
                Status = "Host",
                DateCreated = DateTime.UtcNow,
                DateUpdated = DateTime.UtcNow,
                CreatedBy = email,
                UpdatedBy = email
            });

            // 5) Add selected restaurants (distinct)
            var restaurantIds = selected.Distinct().ToList();

            foreach (var rid in restaurantIds)
            {
                ctx.GroupOrderRestaurant.Add(new GroupOrderRestaurant
                {
                    GroupOrderId = groupOrder.Id,
                    RestaurantId = rid
                });
            }

            await ctx.SaveChangesAsync();

            // 6) Store state (optional but useful)
            GroupOrderState.Clear();
            GroupOrderState.GroupOrderId = groupOrder.Id;
            GroupOrderState.GroupCode = groupOrder.GroupCode;
            GroupOrderState.MallId = groupOrder.MallId;
            GroupOrderState.SelectedRestaurantIds = restaurantIds;

            // 7) Navigate to Lobby
            Nav.NavigateTo($"/grouporders/lobby/{code}");
        }
        catch (Exception ex)
        {
            // ✅ show real DB reason
            error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private static string GenerateCode()
        => Guid.NewGuid().ToString("N")[..6].ToUpperInvariant();
}
