@page "/menuitems/create"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using FoodDeliveryrestart.Domain
@inject IDbContextFactory<FoodDeliveryrestart.Data.FoodDeliveryrestartContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Create</PageTitle>

<div class="form-page">
    <div class="form-card">
        <h1>Create</h1>
        <h2>Menu Item</h2>

        <EditForm method="post" Model="MenuItem" OnValidSubmit="AddMenuItem" FormName="create" Enhance>
            <DataAnnotationsValidator />
            <ValidationSummary class="form-error" />

            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="itemname">Item Name</label>
                        <InputText id="itemname" @bind-Value="MenuItem.ItemName" />
                        <ValidationMessage For="() => MenuItem.ItemName" />
                    </div>

                    <div class="form-group">
                        <label for="price">Price</label>
                        <InputNumber id="price" @bind-Value="MenuItem.Price" />
                        <ValidationMessage For="() => MenuItem.Price" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="description">Description</label>
                        <InputText id="description" @bind-Value="MenuItem.Description" />
                        <ValidationMessage For="() => MenuItem.Description" />
                    </div>

                    <div class="form-group">
                        <label for="restaurantid">Restaurant</label>
                        <select id="restaurantid" @bind="MenuItem.RestaurantId">
                            <option value="0">-- Select restaurant --</option>
                            @if (restaurants != null)
                            {
                                @foreach (var r in restaurants)
                                {
                                    <option value="@r.Id">@r.Name (@(r.Mall?.MallName ?? ""))</option>
                                }
                            }
                        </select>
                        <ValidationMessage For="() => MenuItem.RestaurantId" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="calories">Calories (kcal)</label>
                        <InputNumber id="calories" @bind-Value="MenuItem.Calories" />
                        <ValidationMessage For="() => MenuItem.Calories" />
                    </div>

                    <div class="form-group">
                        <label for="carbs">Carbohydrates (g)</label>
                        <InputNumber id="carbs" @bind-Value="MenuItem.CarbohydratesG" />
                        <ValidationMessage For="() => MenuItem.CarbohydratesG" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="protein">Protein (g)</label>
                        <InputNumber id="protein" @bind-Value="MenuItem.ProteinG" />
                        <ValidationMessage For="() => MenuItem.ProteinG" />
                    </div>

                    <div class="form-group">
                        <label for="fat">Fat (g)</label>
                        <InputNumber id="fat" @bind-Value="MenuItem.FatG" />
                        <ValidationMessage For="() => MenuItem.FatG" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="allergens">Allergens</label>
                    <InputText id="allergens" @bind-Value="MenuItem.Allergens" />
                    <ValidationMessage For="() => MenuItem.Allergens" />
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">Create</button>
                <button type="button" class="btn-secondary" @onclick='() => NavigationManager.NavigateTo("/admin/dashboard")'>Cancel</button>
            </div>
        </EditForm>

        <a class="back-link" href="/admin/dashboard">Back to Dashboard</a>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private MenuItem MenuItem { get; set; } = new();

    private List<Restaurant>? restaurants;

    protected override async Task OnInitializedAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        restaurants = await ctx.Restaurant.OrderBy(r => r.Name).ToListAsync();
    }

    // To protect from overposting attacks, see https://learn.microsoft.com/aspnet/core/blazor/forms/#mitigate-overposting-attacks.
    private async Task AddMenuItem()
    {
        using var context = DbFactory.CreateDbContext();
        context.MenuItem.Add(MenuItem);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/admin/dashboard");
    }
}
