@page "/register"
@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data
@rendermode InteractiveServer
<link rel="stylesheet" href="/css/register.css" />
@inject NavigationManager Nav
@inject UserManager<FoodDeliveryrestartUser> UserManager
@inject FoodDeliveryrestart.Services.CustomAuthenticationStateProvider AuthStateProvider

<div class="auth-page">
    <div class="auth-card">
        <div class="logo-container">
            <div class="app-logo">FoodLeh?</div>
            <div class="app-tagline">Your favorite meals, delivered fast</div>
        </div>
        <h2 class="auth-title">Register</h2>
        <p class="auth-sub">Create your account.</p>

        <div class="form-row">
            <div class="form-group">
                <label class="auth-label">First Name</label>
                <input class="auth-input" @bind="FirstName" placeholder="John" />
            </div>
            <div class="form-group">
                <label class="auth-label">Last Name</label>
                <input class="auth-input" @bind="LastName" placeholder="Doe" />
            </div>
        </div>

        <label class="auth-label">Email</label>
        <input class="auth-input" @bind="Email" placeholder="name@email.com" />

        <label class="auth-label">Password</label>
        <input class="auth-input" type="password" @bind="Password" placeholder="••••••••" />

        <label class="auth-label">Confirm Password</label>
        <input class="auth-input" type="password" @bind="ConfirmPassword" placeholder="••••••••" />

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <div class="auth-error">@Error</div>
        }

        @if (!string.IsNullOrWhiteSpace(Success))
        {
            <div style="background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin: 10px 0;">
                @Success
            </div>
        }

        <button class="auth-btn" @onclick="DoRegister" disabled="@IsLoading">
            @(IsLoading ? "Creating account..." : "Create Account")
        </button>

        <div class="auth-footer">
            Already have an account?
            <a class="auth-link" href="/login">Login</a>
        </div>
    </div>
</div>

@code {
    private string FirstName = "";
    private string LastName = "";
    private string Email = "";
    private string Password = "";
    private string ConfirmPassword = "";
    private string Error = "";
    private string Success = "";
    private bool IsLoading = false;

    private async Task DoRegister()
    {
        Error = "";
        Success = "";
        IsLoading = true;

        try
        {
            if (string.IsNullOrWhiteSpace(FirstName) || string.IsNullOrWhiteSpace(LastName) ||
                string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
            {
                Error = "Please fill in all fields.";
                return;
            }

            if (Password != ConfirmPassword)
            {
                Error = "Passwords do not match.";
                return;
            }

            if (Password.Length < 6)
            {
                Error = "Password must be at least 6 characters long.";
                return;
            }

            var user = new FoodDeliveryrestartUser
            {
                UserName = Email.Trim(),
                Email = Email.Trim(),
                FirstName = FirstName.Trim(),
                LastName = LastName.Trim(),
                EmailConfirmed = true
            };

            var result = await UserManager.CreateAsync(user, Password);

            if (result.Succeeded)
            {
                await UserManager.AddToRoleAsync(user, "Customer");
                Success = "Account created successfully! Redirecting to login...";
                StateHasChanged();

                await Task.Delay(1500);
                Nav.NavigateTo("/login", forceLoad: true);
            }
            else
            {
                Error = string.Join(" ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            Error = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }
}