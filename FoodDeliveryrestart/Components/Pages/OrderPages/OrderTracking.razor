@page "/orders/{OrderId:int}/track"
@rendermode InteractiveServer
@implements IDisposable

@using FoodDeliveryrestart.Domain
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<FoodDeliveryrestart.Data.FoodDeliveryrestartContext> DbFactory
@inject NavigationManager Nav

<PageTitle>Track Delivery</PageTitle>

<div class="track-wrap">
    <div class="track-hero">
        <div>
            <button type="button" class="btn-ghost" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i>
                Back to Order
            </button>

            <h1 class="title">Delivery Tracking</h1>
            <div class="muted">Tap a step to view details (like Grab).</div>
        </div>

        <div class="pill">
            Order <strong>#@OrderId</strong>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="panel"><p>Loading tracking…</p></div>
    }
    else if (!string.IsNullOrWhiteSpace(Error))
    {
        <div class="panel"><p class="err">@Error</p></div>
    }
    else if (Order is null)
    {
        <div class="panel"><p>Order not found.</p></div>
    }
    else
    {
        <div class="grid">
            <!-- LEFT -->
            <div class="panel">
                <div class="panel-head">
                    <h3>Status</h3>
                    <span class="pill small">@GetStageText(CurrentStage)</span>
                </div>

                <div class="eta">
                    <div class="eta-title">@SelectedStep.Title</div>
                    <div class="eta-value">@SelectedCountdownText</div>
                    <div class="muted">
                        Timestamp: <strong>@SelectedTimestampText</strong>
                    </div>
                    <div class="muted small-note">
                        Each stage is 1 minute (demo). Refresh keeps progress (saved in DB).
                    </div>
                </div>

                <div class="timeline">
                    @foreach (var step in Steps)
                    {
                        var state = GetStepState(step.Index);
                        var isSelected = step.Index == SelectedStepIndex;

                        <button type="button"
                                class="step-btn"
                                @onclick="@(() => SelectStep(step.Index))">
                            <div class="step @state @(isSelected ? "selected" : "")">
                                <div class="dot">
                                    <i class="@step.Icon"></i>
                                </div>

                                <div class="info">
                                    <div class="step-title">@step.Title</div>
                                    <div class="muted">@step.Desc</div>
                                    <div class="time muted">
                                        <i class="bi bi-clock"></i>
                                        @GetStepTimestampText(step.Index)
                                    </div>
                                </div>

                                <div class="badge @state">
                                    @GetBadgeText(step.Index)
                                </div>
                            </div>
                        </button>
                    }
                </div>

                <div class="actions">
                    <button type="button" class="btn-primary" @onclick="RestartDemo">Restart Demo</button>

                    <!-- demo/testing controls -->
                    <button type="button" class="btn-ghost" @onclick="@(() => ForceStage(0))">Preparing</button>
                    <button type="button" class="btn-ghost" @onclick="@(() => ForceStage(1))">Picked Up</button>
                    <button type="button" class="btn-ghost" @onclick="@(() => ForceStage(2))">Delivering</button>
                    <button type="button" class="btn-ghost" @onclick="@(() => ForceStage(3))">Delivered</button>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="panel">
                <div class="panel-head">
                    <h3>Progress</h3>
                    <span class="pill small">@($"{ProgressPercent}%")</span>
                </div>

                <div class="progress-bar" role="progressbar" aria-valuenow="@ProgressPercent" aria-valuemin="0" aria-valuemax="100">
                    <div class="fill" style="@($"width:{ProgressPercent}%")"></div>
                </div>

                <div class="rider-card">
                    <div class="rider-icon"><i class="bi bi-bicycle"></i></div>
                    <div>
                        <div class="rider-title">Demo Rider</div>
                        <div class="muted">Moves as stage updates</div>
                    </div>
                </div>

                <div class="mini-map">
                    <div class="map-labels">
                        <span class="map-pill"><i class="bi bi-shop"></i> Restaurant</span>
                        <span class="map-pill"><i class="bi bi-geo-alt"></i> You</span>
                    </div>

                    <div class="map-line">
                        <div class="moving" style="@($"left:{RiderLeftPercent}%")"></div>
                    </div>

                    <div class="muted small-note">
                        Current stage: <strong>@GetStageText(CurrentStage)</strong><br />
                        Stage countdown: <strong>@StageCountdownText</strong>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .track-wrap { padding: 18px; max-width: 1100px; margin: 0 auto; }
    .track-hero { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:14px; }
    .title { margin: 10px 0 4px; }

    .grid { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:14px; }

    .panel {
        background:#fff;
        border:1px solid #eee;
        border-radius:18px;
        padding:14px;
        box-shadow:0 10px 22px rgba(0,0,0,.06);
    }

    .panel-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .muted { opacity:.7; }
    .small-note { margin-top:8px; font-size:.9rem; }

    .pill {
        display:inline-flex; align-items:center; gap:6px;
        padding:8px 12px; border-radius:999px;
        border:1px solid #e8e8e8; background:#fff; font-size:.95rem;
    }
    .pill.small { padding:6px 10px; font-size:.85rem; }

    .btn-primary {
        background:#111; color:#fff; border:none;
        padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn-primary:hover { opacity:.92; }

    .btn-ghost {
        background:#fff; color:#111; border:1px solid #ddd;
        padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn-ghost:hover { background:#fafafa; }

    .err { color:#b00020; font-weight:700; }

    .eta {
        background:#f7f7f9;
        border:1px solid #ededf2;
        border-radius:14px;
        padding:12px;
        margin-bottom:14px;
    }
    .eta-title { font-weight:900; margin-bottom:4px; }
    .eta-value { font-size:1.35rem; font-weight:900; }

    .timeline { display:flex; flex-direction:column; gap:10px; }
    .step-btn { border:none; background:transparent; padding:0; text-align:left; cursor:pointer; width:100%; }

    .step {
        display:flex; align-items:flex-start; gap:12px;
        padding:12px; border-radius:14px;
        border:1px solid #eee; background:#fff;
        transition:transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .step:hover { transform: translateY(-1px); }

    .step.selected { border-color:#111; background:#fafafa; }
    .step.active { border-color:#cfd3ff; background:#f7f8ff; }
    .step.done { border-color:#d8f0df; background:#f3fbf6; }

    .dot {
        width:42px; height:42px; border-radius:14px;
        border:1px solid #ececec; background:#fff;
        display:flex; align-items:center; justify-content:center;
        flex:0 0 auto; font-size:1.1rem;
    }
    .step.active .dot { animation: pulse 1.2s ease-in-out infinite; }

    .info { flex:1; }
    .step-title { font-weight:900; }
    .time { margin-top:6px; display:flex; gap:8px; align-items:center; }

    .badge {
        padding:6px 10px; border-radius:999px;
        border:1px solid #e7e7e7;
        background:#fafafa; font-size:.82rem;
        height:max-content;
        text-transform: uppercase;
        letter-spacing: .4px;
    }
    .badge.done { background:#f3fbf6; border-color:#d8f0df; }
    .badge.active { background:#f0f2ff; border-color:#cfd3ff; }

    .actions { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }

    .progress-bar {
        height:12px; border-radius:999px;
        background:#f1f1f1; border:1px solid #eee;
        overflow:hidden; margin-bottom:14px;
    }
    .fill { height:100%; background:#111; border-radius:999px; transition:width .35s ease; }

    .rider-card {
        display:flex; gap:10px; align-items:center;
        padding:12px; border:1px solid #eee; border-radius:14px;
        background:#fff; margin-bottom:14px;
    }
    .rider-icon {
        width:42px; height:42px; border-radius:14px;
        border:1px solid #ececec;
        display:flex; align-items:center; justify-content:center;
        font-size:1.2rem;
    }
    .rider-title { font-weight:900; }

    .mini-map { border:1px solid #eee; border-radius:14px; padding:12px; background:#fff; }
    .map-labels { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .map-pill {
        font-size:.85rem; border:1px solid #eee;
        padding:6px 10px; border-radius:999px;
        background:#fafafa; display:inline-flex; gap:8px; align-items:center;
    }

    .map-line {
        position:relative; height:14px; border-radius:999px;
        background:repeating-linear-gradient(90deg, #efefef 0px, #efefef 10px, #ffffff 10px, #ffffff 20px);
        border:1px solid #eee;
        overflow:hidden;
    }
    .moving {
        position:absolute; top:50%; transform:translate(-50%, -50%);
        width:26px; height:26px; border-radius:12px;
        background:#111; box-shadow:0 10px 22px rgba(0,0,0,.12);
    }
    .moving::after {
        content:"🚴";
        position:absolute; inset:0;
        display:flex; align-items:center; justify-content:center;
        font-size:14px; filter:grayscale(100%);
    }

    /* ✅ Razor needs @@ here */
    @@media (max-width: 900px) {
        .grid { grid-template-columns: 1fr; }
        .track-wrap { padding: 12px; }
    }

    /* ✅ Razor needs @@ here */
    @@keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.03); }
        100% { transform: scale(1); }
    }
</style>

@code {
    [Parameter] public int OrderId { get; set; }

    private bool IsLoading = true;
    private string? Error;
    private Order? Order;

    private Timer? timer;

    private readonly List<StepInfo> Steps = new()
    {
        new StepInfo(0, "Preparing",  "Restaurant is preparing your food (1 min).", "bi bi-bag-check"),
        new StepInfo(1, "Picked Up",  "Rider picked up your food (1 min).",        "bi bi-box-seam"),
        new StepInfo(2, "Delivering", "Rider is delivering to you (1 min).",       "bi bi-truck"),
        new StepInfo(3, "Delivered",  "Enjoy your meal! 🎉",                       "bi bi-check-circle")
    };

    private int SelectedStepIndex = 0;

    // ✅ supports byte / byte? / int / int?
    private int CurrentStage
        => ClampInt(Convert.ToInt32(Order?.DeliveryStage ?? (byte)0), 0, 3);

    private StepInfo SelectedStep => Steps[ClampInt(SelectedStepIndex, 0, Steps.Count - 1)];

    private int ProgressPercent
    {
        get
        {
            var max = Steps.Count - 1;
            var pct = (int)Math.Round((CurrentStage / (double)max) * 100);
            return ClampInt(pct, 0, 100);
        }
    }

    private double RiderLeftPercent
    {
        get
        {
            var max = Steps.Count - 1;
            var pct = (CurrentStage / (double)max) * 100.0;
            return Math.Clamp(pct, 0.0, 100.0);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        IsLoading = true;
        Error = null;
        Order = null;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            Order = await db.Order.FirstOrDefaultAsync(o => o.Id == OrderId);

            if (Order != null)
            {
                if (Order.DeliveryStartedUtc == null)
                {
                    var now = DateTime.UtcNow;
                    Order.DeliveryStartedUtc = now;
                    Order.DeliveryStage = (byte)0;
                    Order.DeliveryStageUpdatedUtc = now;
                    await db.SaveChangesAsync();
                }

                SelectedStepIndex = CurrentStage;
                StartTimer();
            }
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void StartTimer()
    {
        timer?.Dispose();

        timer = new Timer(async _ =>
        {
            try
            {
                if (Order == null) return;

                var started = Order.DeliveryStartedUtc ?? DateTime.UtcNow;
                var elapsedSec = (DateTime.UtcNow - started).TotalSeconds;

                var computedStage = (int)(elapsedSec / 60.0);
                computedStage = ClampInt(computedStage, 0, 3);

                if (computedStage != CurrentStage)
                {
                    await PersistStage(computedStage);
                }

                await InvokeAsync(StateHasChanged);
            }
            catch
            {
                // ignore
            }
        }, null, 0, 1000);
    }

    private async Task PersistStage(int newStage)
    {
        if (Order == null) return;

        newStage = ClampInt(newStage, 0, 3);

        Order.DeliveryStage = (byte)newStage;
        Order.DeliveryStageUpdatedUtc = DateTime.UtcNow;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var o = await db.Order.FirstOrDefaultAsync(x => x.Id == OrderId);
            if (o != null)
            {
                o.DeliveryStage = (byte)newStage;
                o.DeliveryStageUpdatedUtc = Order.DeliveryStageUpdatedUtc;
                await db.SaveChangesAsync();

                // keep local Order in sync (in case of tracking refresh)
                Order = o;
            }
        }
        catch
        {
            // ignore
        }
    }

    // ✅ each stage has its own countdown (1 min each)
    private string StageCountdownText
    {
        get
        {
            if (Order?.DeliveryStartedUtc == null) return "--";
            if (CurrentStage >= 3) return "Delivered ✅";

            var started = Order.DeliveryStartedUtc.Value;

            var stageStartUtc = started.AddMinutes(CurrentStage);
            var stageEndUtc = stageStartUtc.AddMinutes(1);

            var remaining = stageEndUtc - DateTime.UtcNow;
            if (remaining.TotalSeconds < 0) remaining = TimeSpan.Zero;

            var sec = (int)Math.Ceiling(remaining.TotalSeconds);
            if (sec < 0) sec = 0;

            return $"{sec}s left";
        }
    }

    private string SelectedCountdownText
    {
        get
        {
            if (Order?.DeliveryStartedUtc == null) return "--";

            if (SelectedStepIndex >= 3)
                return CurrentStage >= 3 ? "Delivered ✅" : "Not yet";

            if (SelectedStepIndex == CurrentStage && CurrentStage < 3)
                return StageCountdownText;

            if (SelectedStepIndex < CurrentStage)
                return "Done ✅";

            var eta = GetStepTimestamp(SelectedStepIndex);
            return $"ETA {eta:HH:mm:ss}";
        }
    }

    private string SelectedTimestampText
    {
        get
        {
            if (Order?.DeliveryStartedUtc == null) return "--";
            var t = GetStepTimestamp(SelectedStepIndex);

            if (SelectedStepIndex < CurrentStage) return $"Completed at {t:HH:mm:ss}";
            if (SelectedStepIndex == CurrentStage) return $"Current stage since {t:HH:mm:ss}";
            return $"Expected at {t:HH:mm:ss}";
        }
    }

    private DateTime GetStepTimestamp(int idx)
    {
        var baseLocal = (Order?.DeliveryStartedUtc ?? DateTime.UtcNow).ToLocalTime();
        return baseLocal.AddMinutes(idx);
    }

    private string GetStepTimestampText(int idx)
    {
        if (Order?.DeliveryStartedUtc == null) return "--";
        var t = GetStepTimestamp(idx);

        if (idx < CurrentStage) return $"At {t:HH:mm:ss}";
        if (idx == CurrentStage) return $"Since {t:HH:mm:ss}";
        return $"ETA {t:HH:mm:ss}";
    }

    private string GetStepState(int idx)
    {
        if (idx < CurrentStage) return "done";
        if (idx == CurrentStage) return "active";
        return "todo";
    }

    private string GetBadgeText(int idx)
    {
        if (idx < CurrentStage) return "Done";
        if (idx == CurrentStage) return "Now";
        return "Soon";
    }

    private void SelectStep(int idx)
    {
        SelectedStepIndex = ClampInt(idx, 0, Steps.Count - 1);
    }

    private async Task RestartDemo()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var o = await db.Order.FirstOrDefaultAsync(x => x.Id == OrderId);
            if (o != null)
            {
                var now = DateTime.UtcNow;
                o.DeliveryStage = (byte)0;
                o.DeliveryStartedUtc = now;
                o.DeliveryStageUpdatedUtc = now;
                await db.SaveChangesAsync();

                Order = o;
                SelectedStepIndex = 0;
            }
        }
        catch { }

        StateHasChanged();
    }

    private async Task ForceStage(int stage)
    {
        stage = ClampInt(stage, 0, 3);
        if (Order == null) return;

        var now = DateTime.UtcNow;
        var started = now.AddMinutes(-stage);

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var o = await db.Order.FirstOrDefaultAsync(x => x.Id == OrderId);
            if (o != null)
            {
                o.DeliveryStartedUtc = started;
                o.DeliveryStage = (byte)stage;
                o.DeliveryStageUpdatedUtc = now;
                await db.SaveChangesAsync();

                Order = o;
                SelectedStepIndex = stage;
            }
        }
        catch { }

        StateHasChanged();
    }

    private static string GetStageText(int stage) => stage switch
    {
        0 => "Preparing",
        1 => "Picked up",
        2 => "Delivering",
        3 => "Delivered",
        _ => "Preparing"
    };

    private void GoBack() => Nav.NavigateTo($"/orders/{OrderId}");

    public void Dispose()
    {
        timer?.Dispose();
    }

    private static int ClampInt(int value, int min, int max)
        => value < min ? min : (value > max ? max : value);

    private record StepInfo(int Index, string Title, string Desc, string Icon);
}
