@page "/profile"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data
@using System.Security.Claims

@inject AuthenticationStateProvider Auth
@inject NavigationManager Nav
@inject UserManager<FoodDeliveryrestartUser> UserManager

<PageTitle>Profile</PageTitle>

<div class="profile-hero">
    <div class="hero-content">
        <h1>My Profile</h1>
        <p class="subtitle">Manage your account & access your orders.</p>
    </div>
</div>

<div class="profile-container">
    @if (loading)
    {
        <div class="cardish">Loading…</div>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="error">@error</div>
    }
    else
    {
        <div class="profile-grid">
            <div class="cardish">
                <h3>Account Information</h3>

                @if (!string.IsNullOrWhiteSpace(successMessage))
                {
                    <div class="success-message">@successMessage</div>
                }

                <div class="info-row">
                    <span class="label">Name</span>
                    @if (editingName)
                    {
                        <div class="edit-field">
                            <input class="edit-input" @bind="editName" placeholder="Enter name" />
                            <button class="btn-save" @onclick="SaveName" disabled="@saving">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn-cancel" @onclick="CancelEditName">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <span class="value">
                            @name
                            <button class="btn-edit" @onclick="StartEditName" title="Edit Name">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </span>
                    }
                </div>
                <div class="info-row">
                    <span class="label">Email</span>
                    @if (editingEmail)
                    {
                        <div class="edit-field">
                            <input class="edit-input" type="email" @bind="editEmail" placeholder="Enter email" />
                            <button class="btn-save" @onclick="SaveEmail" disabled="@saving">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn-cancel" @onclick="CancelEditEmail">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <span class="value">
                            @email
                            <button class="btn-edit" @onclick="StartEditEmail" title="Edit Email">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </span>
                    }
                </div>
                <div class="info-row">
                    <span class="label">Role</span>
                    <span class="value">@role</span>
                </div>
            </div>

            <div class="cardish">
                <h3>Quick Actions</h3>

                <div class="actions">
                    <button class="btn-ghost" @onclick="GoRestaurants">
                        Browse Restaurants
                    </button>

                    <button class="btn-ghost" @onclick="GoMyVouchers">
                        My Vouchers
                    </button>

                    <button class="btn-ghost" @onclick="GoMyGroupOrders">
                        My Group Orders
                    </button>

                    <button class="btn-ghost" @onclick="GoJoinGroup">
                        Join Group by Code
                    </button>

                    @if (isAdmin)
                    {
                        <button class="btn-ghost" @onclick="GoAdminDashboard">
                            Admin Dashboard
                        </button>
                    }

                    <button class="btn-danger" @onclick="Logout">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool loading = true;
    private string? error;
    private string? successMessage;

    private string name = "-";
    private string email = "-";
    private string role = "User";
    private bool isAdmin;
    private string? userId;

    // Edit state
    private bool editingName = false;
    private bool editingEmail = false;
    private string editName = "";
    private string editEmail = "";
    private bool saving = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await Auth.GetAuthenticationStateAsync();
            var user = state.User;

            if (user?.Identity?.IsAuthenticated != true)
            {
                error = "You are not logged in.";
                return;
            }

            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            email = user.FindFirst(ClaimTypes.Email)?.Value ?? user.Identity?.Name ?? "-";
            name = user.FindFirst("given_name")?.Value
                   ?? user.Identity?.Name
                   ?? "User";

            // Load actual user data from database
            if (!string.IsNullOrEmpty(userId))
            {
                var dbUser = await UserManager.FindByIdAsync(userId);
                if (dbUser != null)
                {
                    name = $"{dbUser.FirstName} {dbUser.LastName}".Trim();
                    if (string.IsNullOrWhiteSpace(name)) name = dbUser.UserName ?? "-";
                    email = dbUser.Email ?? "-";
                }
            }

            // Try to show roles from common claim types (ClaimTypes.Role and "role") and detect admin (case-insensitive)
            var roles = user.FindAll(ClaimTypes.Role).Select(r => r.Value)
                        .Concat(user.FindAll("role").Select(r => r.Value))
                        .Where(v => !string.IsNullOrWhiteSpace(v))
                        .Select(v => v.Trim())
                        .ToList();

            if (roles.Count > 0)
                role = roles[0];

            isAdmin = roles.Any(r => string.Equals(r, "Administrator", StringComparison.OrdinalIgnoreCase))
                      || user.IsInRole("Administrator");
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private void StartEditName()
    {
        editName = name;
        editingName = true;
        successMessage = null;
    }

    private void CancelEditName()
    {
        editingName = false;
        editName = "";
    }

    private async Task SaveName()
    {
        if (string.IsNullOrWhiteSpace(editName) || string.IsNullOrEmpty(userId))
            return;

        saving = true;
        try
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                var nameParts = editName.Trim().Split(' ', 2);
                user.FirstName = nameParts[0];
                user.LastName = nameParts.Length > 1 ? nameParts[1] : "";

                var result = await UserManager.UpdateAsync(user);
                if (result.Succeeded)
                {
                    name = editName.Trim();
                    editingName = false;
                    successMessage = "Name updated successfully!";
                }
                else
                {
                    error = string.Join(" ", result.Errors.Select(e => e.Description));
                }
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            saving = false;
        }
    }

    private void StartEditEmail()
    {
        editEmail = email;
        editingEmail = true;
        successMessage = null;
    }

    private void CancelEditEmail()
    {
        editingEmail = false;
        editEmail = "";
    }

    private async Task SaveEmail()
    {
        if (string.IsNullOrWhiteSpace(editEmail) || string.IsNullOrEmpty(userId))
            return;

        saving = true;
        try
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user != null)
            {
                var newEmail = editEmail.Trim();
                
                // Check if email is already taken
                var existingUser = await UserManager.FindByEmailAsync(newEmail);
                if (existingUser != null && existingUser.Id != userId)
                {
                    error = "This email is already in use.";
                    return;
                }

                user.Email = newEmail;
                user.UserName = newEmail;
                user.NormalizedEmail = newEmail.ToUpperInvariant();
                user.NormalizedUserName = newEmail.ToUpperInvariant();

                var result = await UserManager.UpdateAsync(user);
                if (result.Succeeded)
                {
                    email = newEmail;
                    editingEmail = false;
                    successMessage = "Email updated successfully! Please log in again with your new email.";
                }
                else
                {
                    error = string.Join(" ", result.Errors.Select(e => e.Description));
                }
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            saving = false;
        }
    }

    private void GoRestaurants() => Nav.NavigateTo("/restaurants");
    private void GoMyVouchers() => Nav.NavigateTo("/myvouchers");
    private void GoMyGroupOrders() => Nav.NavigateTo("/grouporders/my");
    private void GoJoinGroup() => Nav.NavigateTo("/grouporders/join");
    private void GoAdminDashboard() => Nav.NavigateTo("/admin/dashboard");

    // Identity default logout endpoint (works if Identity is set up normally)
    private void Logout() => Nav.NavigateTo("/auth/logout", forceLoad: true);

}
