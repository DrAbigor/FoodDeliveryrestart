@page "/reset-password"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Identity
@using FoodDeliveryrestart.Data
@using Microsoft.AspNetCore.WebUtilities
@using System.Net

@inject UserManager<FoodDeliveryrestartUser> UserManager
@inject NavigationManager Nav

<div class="auth-page">
    <div class="auth-card">
        <h2 class="auth-title">Reset Password</h2>
        <p class="auth-sub">Enter your new password.</p>

        <label class="auth-label">Email</label>
        <input class="auth-input" value="@Email" disabled />

        <label class="auth-label">New Password</label>
        <input class="auth-input" type="password" @bind="NewPassword" placeholder="••••••••" />

        <label class="auth-label">Confirm Password</label>
        <input class="auth-input" type="password" @bind="ConfirmPassword" placeholder="••••••••" />

        @if (!string.IsNullOrWhiteSpace(Error))
        {
            <div class="auth-error">@Error</div>
        }

        @if (!string.IsNullOrWhiteSpace(Success))
        {
            <div class="auth-success">@Success</div>
        }

        <button class="auth-btn" @onclick="DoReset" disabled="@IsLoading">
            @(IsLoading ? "Resetting..." : "Reset Password")
        </button>

        <div class="auth-footer">
            <a class="auth-link" href="/login">Back to login</a>
        </div>
    </div>
</div>

@code {
    private string Email = "";
    private string Token = "";
    private string NewPassword = "";
    private string ConfirmPassword = "";

    private string? Error;
    private string? Success;
    private bool IsLoading;

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        Email = query.TryGetValue("email", out var e) ? e.ToString() : "";
        Token = query.TryGetValue("token", out var t) ? t.ToString() : "";
    }

    private async Task DoReset()
    {
        Error = null;
        Success = null;

        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Token))
        {
            Error = "Invalid reset link. Please request a new one.";
            return;
        }

        if (string.IsNullOrWhiteSpace(NewPassword) || string.IsNullOrWhiteSpace(ConfirmPassword))
        {
            Error = "Please enter and confirm your new password.";
            return;
        }

        if (NewPassword != ConfirmPassword)
        {
            Error = "Passwords do not match.";
            return;
        }

        IsLoading = true;

        try
        {
            var user = await UserManager.FindByEmailAsync(Email.Trim());
            if (user == null)
            {
                Error = "Invalid reset link. Please request a new one.";
                return;
            }

            // ✅ IMPORTANT: decode token back (because it came from URL)
            var decodedToken = WebUtility.UrlDecode(Token);

            var result = await UserManager.ResetPasswordAsync(user, decodedToken, NewPassword);

            if (!result.Succeeded)
            {
                Error = string.Join(" ", result.Errors.Select(e => e.Description));
                return;
            }

            Success = "Password reset successful. Redirecting to login...";
            StateHasChanged();

            // ✅ Optional: auto redirect
            await Task.Delay(1200);
            Nav.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Error = ex.Message;
        }
        finally
        {
            IsLoading = false;
        }
    }
}
